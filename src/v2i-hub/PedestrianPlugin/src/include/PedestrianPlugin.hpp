//==========================================================================
// Name        : PedestrianPlugin.cpp
// Author      : FHWA Saxton Transportation Operations Laboratory  
// Version     :
// Copyright   : Copyright (c) 2024 FHWA Saxton Transportation Operations Laboratory. All rights reserved.
// Description : Pedestrian Plugin
//==========================================================================
#pragma once
#include <string.h>

#include "PluginClient.h"
#include "PluginDataMonitor.h"

#include <atomic>
#include <thread>
#include <mutex>
#include <iostream>
#include <sstream>
#include <unordered_set>
#include <algorithm>
#include <PersonalSafetyMessage.h>
#include <tmx/j2735_messages/J2735MessageFactory.hpp>

#include <UdpClient.h>
#include <tmx/messages/auto_message.hpp>
#include "PedestrianPluginWorker.hpp"

#include "FLIRWebSockAsyncClnSession.hpp"


#include <QCommandLineOption>
#include <QCommandLineParser>
#include <QCoreApplication>
#include <QHostAddress>
#include <QRegExp>
#include <QStringList>
#include <QSharedPointer>
#include <QObject>

#ifdef __linux__
#include <signal.h>
#include <unistd.h>
#endif
#include <qhttpengine/server.h>
#include <qserverPedestrian/OAIApiRouter.h>
#include <qserverPedestrian/OAIPSM.h>
#include <queue>

#include "FLIRConfigurations.hpp"

namespace PedestrianPlugin
{

/**
 * @brief Plugin used to encode messages from an XML input via HTTP POST or metadata received from the FLIR API.
 */
class PedestrianPlugin: public PluginClient
{
public:
	explicit PedestrianPlugin(const std::string &name);
	int Main() override;

protected:
	/**
	 * @brief Called everytime a configuration value is changed for the plugin.
	 */
	void UpdateConfigSettings();
	// Virtual method overrides START
	/**
	 * @brief Overrides PluginClient OnConfigChanged(const char *key, const char *value) method
	 * and calls UpdateConfigSettings() on each configuration change.
	 * @param key string key of the configuration value that has changed.
	 * @param value new value of the configuration that has changed.
	 */
	void OnConfigChanged(const char *key, const char *value) override;
	/**
	 * @brief Overrides PluginClient OnStateChange(IvpPluginState state) method.
	 * @param state new state of the plugin.
	 */
	void OnStateChange(IvpPluginState state) override;
	// Virtual method overrides END.

	/**
	 * @brief Add DSRC metadata to messages and broadcast pedestrian detection information.
	 * @param msgJson PSM, SDSM, or TIM in XML string format.
	 */
	void BroadcastPedDet(const std::string &msgXML);

	/**
	 * @brief Starts WebService to handle incoming HTTP POST requests.
	 */
	int  StartWebService();
	/**
	 * @brief Starts Asyncronous WebSocket Client to connect to FLIR WebSocket Server.
	 */
	int  StartWebSocket(const FLIRConfiguration &config);
	/**
	 * @brief Stops WebService before FLIR WebSocket enabled. 
	 */
	void StopWebService();
	/**
	 * @brief Stops WebSocket Client session before HTTP POST WebService is enabled. 
	 */
	void StopWebSocket();
	/**
	 * @brief Handles HTTP POST requests and sends response to sender. 
	 * If valid XML is received, sends data to BroadcastPedDet.
	 * @param QHttpEngine::Socket Socket created in WebService. 
	 */
	void PedestrianRequestHandler(QHttpEngine::Socket *socket);
	/**
	 * @brief Sends new XMLs generated by FLIR WebSocket session to BroadcastPedDet.
	 */
	void checkXML();
	/**
	 * @brief Parses messages received into BroadcastPedDet to check what kind of message it is (e.g. PSM, SDSM, TIM).
	 * @param message Message XML as a string.
	 */
	std::string parseMessage(const std::string& message) const;
	/**
	 * @brief Parses though user configurations to determine which message(s) to generate. Accepts any combination of PSM, SDSM, and/or TIM. 
	 */
	void getMessageToWrite();

	void processStaticTimXML();

	/**
	 * @brief Updates the TravelerInformationMessage(TIM) XML 
	 * with new information (msgCnt, startYear, int startTime, durationTime).
	 * Return the updated TIM in XML format.
	 * @param staticTimXMLIn Static TravelerInformationMessage(TIM) XML.
	 * @param msgCount Message count to update.
	 * @param startYear Year to update.
	 * @param startTime Time to update.
	 * @param durationTime Duration time to update.
	 * @return Updated TravelerInformationMessage(TIM) XML.
	 */
	string updateTimXML(const string& staticTimXMLIn, int msgCount, int startYear, int startTime, int durationTime);
	/**
	 * @brief Updates the TravelerInformationMessage(TIM) tree with new information (msgCnt, startYear, int startTime, durationTime ).
	 * @param timTree TravelerInformationMessage(TIM) tree to update.
	 */
	void updateTimTree(pt::ptree &timTree, int msgCount, int startYear, int startTime, int durationTime);
	
private:
	J2735MessageFactory factory;
	
	std::mutex _cfgLock;
	
	uint16_t webport;
	std::string webip; 
	// std::string webSocketIP;
	// std::string webSocketURLExt;
	std::string dataprovider;
	// float cameraRotation;
	std::vector<std::shared_ptr<FLIRWebSockAsyncClnSession>> flirSessions;
	// std::string hostString;
	std::shared_ptr<FLIRConfigurations> flirConfigsPtr;
	std::string flirOutput;
	//A static TravelerInformationMessage(TIM) that describes regions at an intersection.
	std::string staticTimXML;
	//Initial static TIM broadcast frequency is set to 1HZ
	int staticTimFrequency = 1;

	bool runningWebSocket = false;
    bool runningWebService = false;

	bool generatePSM = false;
	bool generateSDSM = false;
	bool generateTIM = false;

	// The io_context is required for all I/O
    net::io_context ioc;

	// TODO: Set an endpoint for XML post messages and update documentation.
	// API URL to accept XML
	const QString Msg_Receive = "";
};

};
